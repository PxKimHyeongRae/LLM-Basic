# μ „κ΄‘ν λ©”μ‹μ§€ μƒμ„± κ°μ„  κ°€μ΄λ“

## λ¬Έμ  μƒν™©

λ¨λΈμ΄ μ”μ²­ν• κ°„λ‹¨ν• λ©”μ‹μ§€ λ€μ‹  μ¥ν™©ν• μ¶λ ¥μ„ μƒμ„±ν•λ” λ¬Έμ :

```
μ”μ²­: "μ–΄μ  10λ„, μ¤λ 5λ„ β†’ μ „κ΄‘ν λ©”μ‹μ§€ μƒμ„±"

μλ»λ μ¶λ ¥:
---
**μ „κ΄‘ν λ©”μ‹μ§€:**
μ¤λ κ³µμ›μ€ μ¶¥μµλ‹λ‹¤. κ²‰μ·μ„ μ±™κ²¨μ£Όμ„Έμ”!

(λλ”)
λ”°λ»ν•κ² μ…κ³  μ¤μ„Έμ”!

---
λ‘ λ¬Έμ¥ λ¨λ‘ μμ—°μ¤λ½κ³  μ μ ν•μ§€λ§...

μ›ν•λ” μ¶λ ¥:
μ–΄μ λ³΄λ‹¤ 5λ„ λ‚®μ•„μ΅μµλ‹λ‹¤. μ™Έμ¶ μ‹ λ”°λ»ν•κ² μ…μΌμ„Έμ”.
```

## ν•΄κ²° λ°©μ• μ”μ•½

### β΅ μ¦‰μ‹ μ μ© (μ„μ‹ λ°©νΈ)

1. **Stop Sequences μ¶”κ°€** (`model_server.py:269-307`)
   - λ¶ν•„μ”ν• ν¨ν„΄μ΄ λ‚μ¤λ©΄ μƒμ„± μ¦‰μ‹ μ¤‘λ‹¨
   - `\n\n`, `---`, `**`, `(λλ”)` λ“± κ°μ§€

2. **κ°•λ ¥ν• ν›„μ²λ¦¬** (`model_server.py:82-135`)
   - λ§ν¬λ‹¤μ΄ ν•μ‹ μ κ±°
   - λ μ΄λΈ” μ κ±° ("μ¶λ ¥:", "λ‹µ:")
   - μ²« λ²μ§Έ μ™„μ„±λ λ¬Έμ¥λ§ μ¶”μ¶
   - νΉμλ¬Έμ/μ΄λ¨μ§€ ν•„ν„°λ§

3. **κµ¬μ΅°ν™”λ ν”„λ΅¬ν”„νΈ** (`src/generator/prompt_templates.py:134-179`)
   - `<instruction>`, `<rules>`, `<examples>` νƒκ·Έ μ‚¬μ©
   - 7κ°€μ§€ μ—„κ²©ν• κ·μΉ™ λ…μ‹
   - 6κ°μ λ‹¤μ–‘ν• μμ‹ μ κ³µ

### π― κ·Όλ³Έμ  ν•΄κ²° (νμΈνλ‹)

ν„μ¬ λ² μ΄μ¤ λ¨λΈμ€ μΌλ°μ μΈ λ€ν™”μ— μµμ ν™”λμ–΄ μμ–΄, ν”„λ΅¬ν”„νΈλ§μΌλ΅λ” μ¶λ ¥ ν•μ‹μ„ μ™„λ²½ν•κ² μ μ–΄ν•κΈ° μ–΄λ µμµλ‹λ‹¤.

**νμΈνλ‹μ΄ ν•„μ”ν• μ΄μ :**
- λ¨λΈμ΄ "μ „κ΄‘ν λ©”μ‹μ§€" νƒμ¤ν¬λ¥Ό μμ—°μ¤λ½κ² ν•™μµ
- ν”„λ΅¬ν”„νΈ μ—”μ§€λ‹μ–΄λ§ μ—†μ΄λ„ κ°„κ²°ν• μ¶λ ¥ μƒμ„±
- μΌκ΄€λ ν’μ§κ³Ό ν•μ‹ λ³΄μ¥

## νμΈνλ‹ μ‹¤ν–‰ κ°€μ΄λ“

### 1λ‹¨κ³„: ν•™μµ λ°μ΄ν„° μƒμ„±

```bash
python scripts/prepare_finetuning_data.py
```

**μƒμ„±λλ” λ°μ΄ν„°:**
- `data/train_structured.jsonl`: ν•™μµ λ°μ΄ν„° (~50κ°)
- `data/validation_structured.jsonl`: κ²€μ¦ λ°μ΄ν„° (~5κ°)

**λ°μ΄ν„° κµ¬μ„±:**
- μ¨λ„ λΉ„κµ μ‹λ‚λ¦¬μ¤: 35κ°
  - ν° μ¨λ„ λ³€ν™” (Β±10λ„ μ΄μƒ)
  - μ¤‘κ°„ μ¨λ„ λ³€ν™” (Β±5-10λ„)
  - μ‘μ€ μ¨λ„ λ³€ν™” (Β±1-4λ„)
  - κ·Ήν• μ¨λ„ μƒν™©
  - κ³„μ  μ „ν™κΈ°
- μΌλ° λ‚ μ”¨ μƒν™©: 10κ°
  - ν­μ—Ό, ν•ν, λ―Έμ„Έλ¨Όμ§€, λΉ„/λ μλ³΄ λ“±

**ν”„λ΅¬ν”„νΈ ν•μ‹:**
```
<instruction>
λ‹Ήμ‹ μ€ κ³µμ› μ „κ΄‘ν λ©”μ‹μ§€ μ „λ¬Έκ°€μ…λ‹λ‹¤. μ£Όμ–΄μ§„ μ¨λ„ λ°μ΄ν„°λ¥Ό κ°„κ²°ν• ν• λ¬Έμ¥μΌλ΅ λ³€ν™ν•μ„Έμ”.
</instruction>

<rules>
1. λ°λ“μ‹ ν• λ¬Έμ¥λ§ μ¶λ ¥ν•μ„Έμ”
2. λ§ν¬λ‹¤μ΄(**, ---, #), νΉμλ¬Έμ, μ΄λ¨μ§€ μ‚¬μ© κΈμ§€
3. κ΄„νΈλ‚ μ„¤λ… μ¶”κ°€ κΈμ§€
4. μ§λ¬Έ ν•μ‹ κΈμ§€
5. "μ¶λ ¥:", "λ‹µ:", "λ©”μ‹μ§€:" κ°™μ€ λ μ΄λΈ” μ—†μ΄ λ©”μ‹μ§€λ§ μ‘μ„±
6. 40-70μ κΈΈμ΄λ΅ μ‘μ„±
7. μ¨λ„ μ°¨μ΄λ¥Ό κµ¬μ²΄μ  μ«μλ΅ λ…μ‹ (μ: "5λ„", "10λ„")
</rules>

<task>
μ…λ ¥: μ–΄μ  10λ„, μ¤λ 5λ„
μ¶λ ¥: μ–΄μ λ³΄λ‹¤ 5λ„ λ‚®μ•„μ΅μµλ‹λ‹¤. μ™Έμ¶ μ‹ λ”°λ»ν•κ² μ…μΌμ„Έμ”.
```

### 2λ‹¨κ³„: νμΈνλ‹ μ‹¤ν–‰

```bash
python scripts/finetune_model_v2.py
```

**ν•™μµ μ„¤μ •:**
- λ¨λΈ: KORMo-10B-sft
- μ–‘μν™”: 4-bit (λ©”λ¨λ¦¬ ~6GB)
- LoRA rank: 32 (λ” λ§μ€ νλΌλ―Έν„° ν•™μµ)
- Epoch: 5
- Learning rate: 3e-4
- μμƒ μ‹κ°„: ~30-60λ¶„ (GPU μ„±λ¥μ— λ”°λΌ)

**μ €μ¥ μ„μΉ:** `./finetuned_model_v2/`

### 3λ‹¨κ³„: νμΈνλ‹ λ¨λΈ μ‚¬μ©

1. `.env` νμΌ μμ •:
```bash
USE_FINETUNED=true
ADAPTER_PATH=./finetuned_model_v2
```

2. μ„λ²„ μ¬μ‹μ‘:
```bash
python model_server.py
```

## μ„±λ¥ λΉ„κµ μμƒ

### Before (λ² μ΄μ¤ λ¨λΈ + ν”„λ΅¬ν”„νΈ)
```
μ…λ ¥: "μ–΄μ  10λ„, μ¤λ 5λ„"

μ¶λ ¥: "---\n**μ „κ΄‘ν λ©”μ‹μ§€:**\nμ¤λμ€ μ¶¥μµλ‹λ‹¤. κ²‰μ·μ„ μ±™κ²¨μ£Όμ„Έμ”!\n\n(λλ”)..."
```

### After (μ¦‰μ‹ μ μ© κ°μ„ )
```
μ…λ ¥: "μ–΄μ  10λ„, μ¤λ 5λ„"

μ¶λ ¥: "μ¤λμ€ μ¶¥μµλ‹λ‹¤. κ²‰μ·μ„ μ±™κ²¨μ£Όμ„Έμ”"
```
- β… λ§ν¬λ‹¤μ΄ μ κ±°
- β… ν• λ¬Έμ¥λ§ μ¶”μ¶
- β οΈ μ—¬μ „ν "μ–΄μ λ³΄λ‹¤ 5λ„" κ°™μ€ μ •λ³΄ λ„λ½ κ°€λ¥

### After (νμΈνλ‹)
```
μ…λ ¥: "μ–΄μ  10λ„, μ¤λ 5λ„"

μ¶λ ¥: "μ–΄μ λ³΄λ‹¤ 5λ„ λ‚®μ•„μ΅μµλ‹λ‹¤. μ™Έμ¶ μ‹ λ”°λ»ν•κ² μ…μΌμ„Έμ”."
```
- β… μ™„λ²½ν• ν•μ‹
- β… λ¨λ“  μ •λ³΄ ν¬ν•¨
- β… μΌκ΄€λ ν’μ§

## νμΌ λ³€κ²½ μ‚¬ν•­

### μμ •λ νμΌ

1. **`model_server.py`**
   - Stop sequences μ¶”κ°€ (61-80μ¤„)
   - ν›„μ²λ¦¬ ν•¨μ κ°•ν™” (82-135μ¤„)
   - Generate λ΅μ§ κ°μ„  (287-331μ¤„)

2. **`src/generator/prompt_templates.py`**
   - κµ¬μ΅°ν™”λ ν”„λ΅¬ν”„νΈ ν…ν”λ¦Ώ (134-179μ¤„)
   - λ…ν™•ν• κ·μΉ™κ³Ό μμ‹ μ¶”κ°€

3. **`test_prompts.txt`**
   - ν…μ¤νΈ κ°€μ΄λ“ λ° μμ‹ μ¶”κ°€

### μƒλ΅ μƒμ„±λ νμΌ

1. **`scripts/prepare_finetuning_data.py`**
   - νμΈνλ‹ λ°μ΄ν„° μƒμ„± μ¤ν¬λ¦½νΈ
   - 45κ°μ λ‹¤μ–‘ν• μ‹λ‚λ¦¬μ¤ ν¬ν•¨

2. **`scripts/finetune_model_v2.py`**
   - μƒλ΅μ΄ ν”„λ΅¬ν”„νΈ ν•μ‹μ© νμΈνλ‹ μ¤ν¬λ¦½νΈ
   - κ°μ„ λ ν•™μµ μ„¤μ •

3. **`IMPROVEMENT_GUIDE.md`** (μ΄ νμΌ)
   - μ „μ²΄ κ°μ„  κ°€μ΄λ“

## ν…μ¤νΈ λ°©λ²•

### 1. μ„λ²„ μ¬μ‹μ‘
```bash
python model_server.py
```

### 2. API ν…μ¤νΈ (curl)
```bash
curl -X POST "http://localhost:8000/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "μ–΄μ μ ν‰κ· μ¨λ„λ” 10λ„κ³  μ¤λμ ν‰κ· μ¨λ„λ” 5λ„μ•Ό. κ³µμ›μ„ λ°©λ¬Έν•λ” κ³ κ°λ“¤μ—κ² μ μ ν•κ² μ „λ‹¬ν•΄μ¤„ μ „κ΄‘ν λ©”μ‹μ§€λ¥Ό ν•μ¤„λ΅ κ°„κ²°ν•κ² μ‘μ„±ν•΄μ¤.",
    "max_new_tokens": 50,
    "temperature": 0.7
  }'
```

### 3. ν”„λ΅¬ν”„νΈ ν…ν”λ¦Ώ μ‚¬μ© ν…μ¤νΈ
```python
from src.generator.prompt_templates import PromptTemplates

comparison_data = {
    'yesterday_avg_temp': 10,
    'today_avg_temp': 5,
    'temp_change': -5,
    'temp_change_direction': 'ν•κ°•'
}

prompt = PromptTemplates.get_temperature_comparison_prompt(comparison_data)
# APIλ΅ μ „μ†΅...
```

## μ¶”κ°€ κ°μ„  μ•„μ΄λ””μ–΄

1. **DPO (Direct Preference Optimization)**
   - μΆ‹μ€ λ©”μ‹μ§€ vs λ‚μ λ©”μ‹μ§€ μ ν•™μµ
   - `scripts/finetune_dpo.py` ν™μ© κ°€λ¥

2. **λ” λ§μ€ ν•™μµ λ°μ΄ν„°**
   - μ‹¤μ  μ „κ΄‘ν λ©”μ‹μ§€ μμ§‘
   - ν¬λΌμ°λ“μ†μ‹±μΌλ΅ λ°μ΄ν„° ν™•μ¥

3. **λ‹¤μ–‘ν• μƒν™© μ¶”κ°€**
   - κ³µν΄μΌ, μ΄λ²¤νΈ μ•λ‚΄
   - κΈ΄κΈ‰ μƒν™© μ•λ¦Ό
   - μ‹μ„¤λ¬Ό μ κ²€ μ•λ‚΄

4. **A/B ν…μ¤νΈ**
   - λ² μ΄μ¤ λ¨λΈ vs νμΈνλ‹ λ¨λΈ μ„±λ¥ λΉ„κµ
   - μ‚¬μ©μ ν”Όλ“λ°± μμ§‘

## λ¬Έμ  ν•΄κ²°

### Q: νμΈνλ‹ μ¤‘ λ©”λ¨λ¦¬ λ¶€μ΅± μ¤λ¥
A: `scripts/finetune_model_v2.py`μ—μ„ μ„¤μ • μ΅°μ •:
```python
per_device_train_batch_size=1  # 2 -> 1λ΅ κ°μ†
gradient_accumulation_steps=16  # 8 -> 16μΌλ΅ μ¦κ°€
```

### Q: νμΈνλ‹ ν›„μ—λ„ ν’μ§ κ°μ„ μ΄ μ—†μ
A:
1. λ°μ΄ν„° μ–‘ μ¦κ°€ (μµμ† 100κ° μ΄μƒ κ¶μ¥)
2. Epoch μ¦κ°€ (5 -> 10)
3. Learning rate μ΅°μ • (3e-4 -> 2e-4)

### Q: μ¶”λ΅  μ†λ„κ°€ λ„λ¬΄ λλ¦Ό
A:
1. Stop sequences μ μ¤„μ΄κΈ°
2. max_new_tokens κ°μ† (100 -> 50)
3. μ–‘μν™” λ λ²¨ μ΅°μ • (4bit -> 8bit, λ” λΉ λ¦„)

## κ²°λ΅ 

**μ¦‰μ‹ μ μ© κ°€λ¥ν• κ°μ„ **μΌλ΅ μ–΄λ μ •λ„ ν’μ§ ν–¥μƒμ΄ κ°€λ¥ν•μ§€λ§, **νμΈνλ‹**μ΄ κ·Όλ³Έμ μΈ ν•΄κ²°μ±…μ…λ‹λ‹¤.

κ¶μ¥ μμ„:
1. β… Stop sequences + ν›„μ²λ¦¬ (μ¦‰μ‹ μ μ©) - μ™„λ£
2. β… κµ¬μ΅°ν™”λ ν”„λ΅¬ν”„νΈ (μ¦‰μ‹ μ μ©) - μ™„λ£
3. β³ νμΈνλ‹ λ°μ΄ν„° μƒμ„± - μ¤€λΉ„ μ™„λ£
4. β³ νμΈνλ‹ μ‹¤ν–‰ - μ‚¬μ©μ μ‹¤ν–‰ λ€κΈ°
5. β³ μ„±λ¥ ν‰κ°€ λ° λ°λ³µ κ°μ„ 

νμΈνλ‹μ„ μ‹¤ν–‰ν•λ ¤λ©΄:
```bash
# 1λ‹¨κ³„: λ°μ΄ν„° μƒμ„±
python scripts/prepare_finetuning_data.py

# 2λ‹¨κ³„: νμΈνλ‹
python scripts/finetune_model_v2.py

# 3λ‹¨κ³„: .env μ„¤μ • λ³€κ²½ ν›„ μ„λ²„ μ¬μ‹μ‘
```
