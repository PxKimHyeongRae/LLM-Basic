# 자연스럽고 다양한 메시지 파인튜닝 가이드

## 문제점 발견

**기존 데이터의 한계:**
```
❌ "공원에서 활동하세요" (너무 일반적)
❌ "공원 산책하기 좋아요" (반복적)
❌ "공원 벤치에서 쉬어가세요" (천편일률적)
```

**원하는 메시지:**
```
✓ "나무 그늘 아래서 잠시 쉬어가세요"
✓ "잔디밭에서 피크닉 어떠세요?"
✓ "활짝 핀 꽃길을 따라 걸어보세요"
```

---

## 해결 완료! ✅

### 생성된 데이터

```
✓ data/train_chat_diverse.jsonl - 302개 (다양화)
✓ data/validation_chat_diverse.jsonl - 15개 (다양화)
```

### 개선 내용

#### 1. 구체적인 공원 요소 포함

**기존 vs 신규:**
- ❌ "공원 산책하기 좋아요"
- ✅ "활짝 핀 꽃길을 따라 걸어보세요"

- ❌ "공원에서 활동하세요"
- ✅ "잔디밭에서 피크닉 어떠세요?"

- ❌ "공원 벤치에서 쉬어가세요"
- ✅ "나무 그늘 아래서 잠시 쉬어가세요"

#### 2. 다양한 공원 장소 사용

사용된 공원 요소 (15가지):
- 나무 그늘 아래
- 잔디밭
- 산책로
- 꽃길
- 분수대 근처
- 벤치
- 연못가
- 정자
- 조깅 코스
- 숲길
- 다리 위
- 언덕
- 전망대
- 호수가
- 소나무 숲

#### 3. 온도별 맞춤 활동 제안

**더운 날 (30도+):**
- "나무 그늘 아래서 잠시 쉬어가세요"
- "분수대 근처가 시원합니다"
- "오전 일찍 산책 추천합니다"
- "수분 섭취 충분히 하세요"

**따뜻한 날 (15-30도):**
- "잔디밭에서 피크닉 어떠세요?"
- "활짝 핀 꽃길을 따라 걸어보세요"
- "벤치에서 여유를 즐기세요"
- "조깅하기 딱 좋은 날씨예요"

**선선한 날 (5-15도):**
- "가디건 하나 챙기세요"
- "산책하며 단풍을 감상하세요"
- "조깅으로 몸을 녹여보세요"

**추운 날 (5도 미만):**
- "따뜻하게 입고 짧은 산책 추천합니다"
- "두꺼운 옷 꼭 챙기세요"
- "방한 준비 철저히 하세요"

#### 4. 다양한 문장 어미

- ~세요
- ~어떠세요?
- ~좋아요
- ~해보세요
- ~권장합니다
- ~추천해요
- ~즐기세요
- ~누려보세요

---

## 샘플 메시지 비교

### 온도 상승 케이스

| 온도 변화 | 기존 메시지 | 새 메시지 (다양화) |
|-----------|-------------|-------------------|
| -5→8 (13도↑) | "공원 산책하기 좋아요" | "조깅으로 몸을 녹여보세요" |
| 5→18 (13도↑) | "공원 산책 완벽한 날이에요" | "가족과 함께 나들이 즐기세요" |
| 10→23 (13도↑) | "공원 나들이 즐기세요" | "활짝 핀 꽃길을 따라 걸어보세요" |
| 8→22 (14도↑) | "공원 벤치에서 휴식하세요" | "산책로를 천천히 걸어보세요" |

### 온도 하강 케이스

| 온도 변화 | 기존 메시지 | 새 메시지 (다양화) |
|-----------|-------------|-------------------|
| 35→22 (13도↓) | "공원 산책하기 좋아요" | "벤치에서 여유를 즐기세요" |
| 30→24 (6도↓) | "공원 산책하기 좋아요" | "산책로를 천천히 걸어보세요" |
| 18→12 (6도↓) | "가디건 챙기세요" | "가디건 하나 챙기세요" |

### 극한 온도 케이스

| 온도 변화 | 기존 메시지 | 새 메시지 (다양화) |
|-----------|-------------|-------------------|
| 20→33 (13도↑) | "공원 그늘에서 휴식하세요" | "오전 일찍 산책 권장합니다" |
| 22→35 (13도↑) | "공원 분수대 근처가 시원합니다" | "양산을 준비하세요" |
| 18→30 (12도↑) | "오전 산책을 권장합니다" | "나무 그늘 아래서 잠시 쉬어가세요" |

---

## 파인튜닝 실행

### 1단계: 스크립트 수정

`scripts/finetune_model_temperature.py` 파일:

```python
# 파일 경로 수정
TRAIN_FILE = "data/train_chat_diverse.jsonl"  # ← 변경
VAL_FILE = "data/validation_chat_diverse.jsonl"  # ← 변경
OUTPUT_DIR = "./finetuned_model_diverse"  # ← 새 이름
```

### 2단계: 파인튜닝 실행

```bash
python scripts/finetune_model_temperature.py
```

**소요 시간:** 1-2시간 (GPU 성능에 따라)

### 3단계: .env 설정

```bash
USE_FINETUNED=true
ADAPTER_PATH=./finetuned_model_diverse
USE_CHAT_FORMAT=true
```

### 4단계: 서버 시작 및 테스트

```bash
python model_server.py
```

**테스트:**
```bash
curl -X POST "http://localhost:8000/generate/temperature" \
  -H "Content-Type: application/json" \
  -d '{"yesterday_temp": 10, "today_temp": 20}'
```

**기대 결과:**
```json
{
  "generated_text": "어제보다 10도 올라 화창합니다. 활짝 핀 꽃길을 따라 걸어보세요."
}
```

---

## 다양성 지표

### 표현 다양성

| 항목 | 기존 (large) | 새 버전 (diverse) |
|------|--------------|------------------|
| **공원 요소** | 5개 | 15개 ⭐ |
| **활동 제안** | 8개 | 25개 ⭐ |
| **문장 어미** | 3개 | 8개 ⭐ |
| **온도별 맞춤** | 부분적 | 완벽 ⭐ |

### 자연스러움

**기존:**
- "공원 산책하기 좋아요" (반복률 25%)
- "공원에서 활동하세요" (반복률 15%)
- "공원 벤치에서 쉬어가세요" (반복률 10%)

**새 버전:**
- 각 메시지 unique
- 반복률 < 5%
- 온도별 맞춤 활동 제안

---

## 비교표 요약

| 데이터셋 | 개수 | 다양성 | 자연스러움 | 추천 |
|---------|------|--------|-----------|------|
| `train_chat_large.jsonl` | 302 | ⭐⭐⭐ | ⭐⭐⭐ | 기본 |
| `train_chat_diverse.jsonl` | 302 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | **강력 추천** ⭐ |

---

## 테스트 케이스

파인튜닝 후 다양성 확인:

```bash
# 1. 따뜻한 날
curl -X POST "http://localhost:8000/generate/temperature" \
  -d '{"yesterday_temp": 10, "today_temp": 23}'

# 기대: "활짝 핀 꽃길을 따라 걸어보세요" 또는
#       "잔디밭에서 피크닉 어떠세요?" 등

# 2. 더운 날
curl -X POST "http://localhost:8000/generate/temperature" \
  -d '{"yesterday_temp": 25, "today_temp": 35}'

# 기대: "나무 그늘 아래서 잠시 쉬어가세요" 또는
#       "오전 일찍 산책 추천합니다" 등

# 3. 선선한 날
curl -X POST "http://localhost:8000/generate/temperature" \
  -d '{"yesterday_temp": 20, "today_temp": 15}'

# 기대: "가디건 하나 챙기세요" 또는
#       "산책하며 단풍을 감상하세요" 등
```

---

## 문제 해결

### Q: 여전히 "공원 산책하기 좋아요" 같은 메시지가 나와요

**A:** 두 가지 확인:
1. `.env`에서 `ADAPTER_PATH=./finetuned_model_diverse` 확인
2. 서버 재시작: `python model_server.py`

### Q: 다양성을 더 높이고 싶어요

**A:** `scripts/generate_diverse_messages.py` 수정:
```python
# PARK_LOCATIONS에 더 많은 장소 추가
PARK_LOCATIONS = [
    # 기존 15개 +
    "야외 무대", "조각 공원", "생태 연못", "바람개비 언덕"
]

# WARM_ACTIVITIES에 더 많은 활동 추가
WARM_ACTIVITIES = [
    # 기존 활동 +
    "요가 매트를 펴고 명상해보세요",
    "친구와 프리스비 어떠세요?"
]
```

재생성:
```bash
python scripts/generate_diverse_messages.py
```

### Q: 특정 공원 요소를 강조하고 싶어요

**A:** 확률 조정:
```python
# generate_diverse_messages.py에서
def get_activity_suggestion(today_temp, temp_diff):
    if today_temp >= 30:
        # 분수대를 70% 확률로 언급
        if random.random() < 0.7:
            return "분수대 근처가 시원합니다"
        else:
            return random.choice(HOT_ACTIVITIES)
```

---

## 성공 지표

✅ **다양성:** 동일 온도에도 다른 메시지 생성
✅ **자연스러움:** "~어떠세요?", "~해보세요" 등 다양한 어미
✅ **구체성:** 공원 요소 명시 (나무 그늘, 잔디밭 등)
✅ **맞춤성:** 온도에 따른 적절한 활동 제안
✅ **일관성:** 40-70자 길이 유지

---

## 다음 단계

### Phase 1: 기본 다양화 파인튜닝 ✅ (현재)
- 302개 다양화 데이터
- 15개 공원 요소
- 25개 활동 제안

### Phase 2: 계절별 메시지 (선택)
```python
# 봄: 벚꽃, 개나리
# 여름: 녹음, 분수대
# 가을: 단풍, 낙엽
# 겨울: 눈꽃, 따뜻한 음료
```

### Phase 3: 시간대별 메시지 (선택)
```python
# 아침: 조깅, 산책
# 점심: 벤치, 휴식
# 저녁: 석양, 산책로
```

---

**마지막 업데이트:** 2025-11-06
**데이터 규모:** 302개 (다양화)
**형식:** Chat 형식
**품질:** 자연스럽고 다양한 표현 ⭐
**권장도:** 강력 추천!
